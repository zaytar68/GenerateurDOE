@page "/document/edit"
@page "/document/edit/{documentId:int}"
@page "/document/edit/nouveau/{chantierId:int}"
@using GenerateurDOE.Components.DocumentEdit

<PageTitle>@PageTitle</PageTitle>

<div class="container-fluid">
    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
    }
    else if (document == null && IsEditMode)
    {
        <div class="alert alert-warning">
            <span class="oi oi-warning" aria-hidden="true"></span>
            Document introuvable
        </div>
    }
    else if (document != null)
    {
        <!-- En-tête avec navigation et actions -->
        <DocumentEditHeader Title="@HeaderTitle"
                           ChantierNom="@chantier?.NomProjet"
                           ShowFinaliseBadge="@(document.EnCours == false)"
                           HasUnsavedChanges="@hasUnsavedChanges"
                           IsSaving="@isSaving"
                           IsGenerating="@isGenerating"
                           ShowFinalizeButton="@(IsEditMode && document.EnCours == true)"
                           ShowGenerateButton="@IsEditMode"
                           ShowDuplicateButton="@IsEditMode"
                           OnRetourClick="@RetourChantier"
                           OnSaveClick="@SauvegarderDocument"
                           OnFinalizeClick="@FinaliserDocument"
                           OnGenerateClick="@GenererDocument"
                           OnEditTemplateClick="@OpenPageGardeEditor" />

        <!-- Onglets de configuration -->
        <DocumentEditTabs @bind-ActiveTab="@activeTab"
                         SectionsCount="@sectionsConteneurs.Sum(sc => sc.Items?.Count ?? 0)"
                         FichesCount="@(ftConteneur?.Elements?.Count ?? 0)">

            <GeneralTabContent>
                <DocumentEditGeneralForm Document="@document"
                                       Templates="@availableTemplates"
                                       @bind-SelectedTypeDocumentString="@selectedTypeDocumentString"
                                       TypeDocumentError="@typeDocumentError"
                                       OnTypeDocumentChanged="@OnTypeDocumentChanged"
                                       OnEditTemplateClick="@OpenPageGardeEditor" />
            </GeneralTabContent>

            <TableMatieresTabContent>
                @if (document != null)
                {
                    <TableMatieresEditor DocumentGenere="@document"
                                       DocumentGenereChanged="@OnDocumentTableMatieresChanged"
                                       SectionsCount="@sectionsConteneurs.Sum(sc => sc.Items?.Count ?? 0)"
                                       FichesCount="@(ftConteneur?.Elements?.Count ?? 0)" />
                }
                else
                {
                    <div class="alert alert-warning">
                        <span class="oi oi-warning" aria-hidden="true"></span>
                        Document non disponible pour la configuration de la table des matières
                    </div>
                }
            </TableMatieresTabContent>

            <SectionsTabContent>
                @if (document.Id > 0)
                {
                    <SectionConteneurEditor SectionsConteneurs="@sectionsConteneurs"
                                          DocumentId="@document.Id"
                                          OnSectionsChanged="@OnSectionsChanged" />
                }
                else
                {
                    <div class="alert alert-warning">
                        <span class="oi oi-warning" aria-hidden="true"></span>
                        Veuillez d'abord sauvegarder le document pour pouvoir gérer les sections
                    </div>
                }
            </SectionsTabContent>

            <FichesTabContent>
                @if (document.Id > 0)
                {
                    @if (ftConteneur == null)
                    {
                        <div class="text-center text-muted py-4">
                            <span class="oi oi-document" style="font-size: 3rem; opacity: 0.3;"></span>
                            <p class="mt-2">Aucun conteneur de fiches techniques</p>
                            <button class="btn btn-primary" @onclick="CreerFTConteneur">
                                <span class="oi oi-plus" aria-hidden="true"></span>
                                Créer Conteneur FT
                            </button>
                        </div>
                    }
                    else
                    {
                        <FTConteneurEditor FTConteneur="@ftConteneur"
                                         OnConteneurChanged="@OnFTConteneurChanged" />
                    }
                }
                else
                {
                    <div class="alert alert-warning">
                        <span class="oi oi-warning" aria-hidden="true"></span>
                        Veuillez d'abord sauvegarder le document pour pouvoir gérer les fiches techniques
                    </div>
                }
            </FichesTabContent>

        </DocumentEditTabs>
    }
</div>

<script>
    window.downloadFile = function (fileName, base64String, mimeType = 'application/pdf') {
        const link = document.createElement('a');
        link.href = 'data:' + mimeType + ';base64,' + base64String;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
</script>