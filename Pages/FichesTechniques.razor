@page "/fiches-techniques"
@using GenerateurDOE.Models
@using GenerateurDOE.Services.Interfaces
@using GenerateurDOE.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.WebUtilities
@using Components
@using Radzen
@using Radzen.Blazor
@inject IFicheTechniqueService FicheTechniqueService
@inject ITypeProduitService TypeProduitService
@inject ITypeDocumentImportService TypeDocumentImportService
@inject ILoadingStateService LoadingStateService
@inject IConfigurationService ConfigurationService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject Radzen.DialogService DialogService

<PageTitle>Fiches Techniques</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Gestion des Fiches Techniques</h2>
                <button class="btn btn-primary" @onclick="OuvrirModalCreation">
                    <i class="oi oi-plus"></i> Nouvelle Fiche
                </button>
            </div>

            <!-- Barre de recherche et filtres -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <AutoComplete T="FicheTechnique"
                                          Items="fiches"
                                          DisplaySelector="GetFicheDisplayText"
                                          Placeholder="Rechercher par produit, fabricant ou type..."
                                          Value="@rechercheText"
                                          OnItemSelected="OnFicheTechniqueSearchSelected"
                                          OnTextChanged="OnFicheTechniqueSearchChanged"
                                          MinSearchLength="2">
                                <ItemTemplate Context="fiche">
                                    <div>
                                        <strong>@fiche.NomProduit</strong>
                                        <br />
                                        <small class="text-muted">
                                            <i class="oi oi-person me-1"></i>@fiche.NomFabricant
                                            <span class="mx-2">•</span>
                                            <i class="oi oi-tag me-1"></i>@fiche.TypeProduit
                                        </small>
                                        @if (!string.IsNullOrEmpty(fiche.Description))
                                        {
                                            <br />
                                            <small class="text-muted"><i class="oi oi-document me-1"></i>@fiche.Description.Substring(0, Math.Min(50, fiche.Description.Length))@(fiche.Description.Length > 50 ? "..." : "")</small>
                                        }
                                    </div>
                                </ItemTemplate>
                            </AutoComplete>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary" @onclick="ReinitialiserFiltres">
                                <i class="oi oi-x"></i> Effacer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bouton Expand/Collapse All -->
            <div class="d-flex justify-content-end mb-2">
                <RadzenButton Text="@((allGroupsExpanded ?? false) ? "Tout replier" : "Tout déplier")"
                              Icon="@((allGroupsExpanded ?? false) ? "unfold_less" : "unfold_more")"
                              ButtonStyle="ButtonStyle.Light"
                              Size="ButtonSize.Small"
                              Click="ToggleTousLesGroupes" />
            </div>

            <!-- RadzenDataGrid avec grouping -->
            <div class="card">
                <div class="card-body p-0">
                    @if (chargement)
                    {
                        <div class="text-center p-5">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large">
                                <Template>Chargement...</Template>
                            </RadzenProgressBarCircular>
                        </div>
                    }
                    else if (!fichesFiltrees.Any())
                    {
                        <div class="text-center text-muted p-5">
                            <RadzenIcon Icon="description" Style="font-size: 3rem; opacity: 0.3;" />
                            <p class="mt-3">Aucune fiche technique trouvée.</p>
                        </div>
                    }
                    else
                    {
                        <RadzenDataGrid @ref="grid"
                                        Data="@fichesPourGrid"
                                        TItem="FicheTechnique"
                                        AllowFiltering="true"
                                        AllowSorting="true"
                                        AllowGrouping="true"
                                        FilterMode="FilterMode.Advanced"
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        Render="@OnRender"
                                        GroupRowRender="OnGroupRowRender"
                                        GroupRowExpand="OnGroupRowExpand"
                                        GroupRowCollapse="OnGroupRowCollapse"
                                        @bind-AllGroupsExpanded="@allGroupsExpanded"
                                        Density="Density.Compact"
                                        class="rz-datatable-fiches">

                            <GroupHeaderTemplate Context="groupContext">
                                @{
                                    var fabricant = groupContext.Data.Key?.ToString() ?? "Non spécifié";
                                }
                                <div style="font-weight: bold; padding: 8px; background-color: var(--info); color: white; border-radius: 4px;">
                                    <RadzenIcon Icon="business" Style="vertical-align: middle; margin-right: 8px;" />
                                    @fabricant
                                </div>
                            </GroupHeaderTemplate>

                            <Columns>
                                <!-- Colonne Fabricant (utilisée pour grouping) -->
                                <RadzenDataGridColumn TItem="FicheTechnique"
                                                      Property="NomFabricant"
                                                      Title="Marque"
                                                      Groupable="true"
                                                      Sortable="true"
                                                      Filterable="true" />

                                <!-- Colonne Produit -->
                                <RadzenDataGridColumn TItem="FicheTechnique"
                                                      Property="NomProduit"
                                                      Title="Produit"
                                                      Sortable="true"
                                                      Filterable="true">
                                    <Template Context="fiche">
                                        <div>
                                            @fiche.NomProduit
                                            @if (fiche == ficheSelectionnee)
                                            {
                                                <RadzenBadge BadgeStyle="BadgeStyle.Primary"
                                                             Text="Sélectionnée"
                                                             Style="margin-left: 8px;" />
                                            }
                                        </div>
                                    </Template>
                                </RadzenDataGridColumn>

                                <!-- Colonne Type -->
                                <RadzenDataGridColumn TItem="FicheTechnique"
                                                      Property="TypeProduit"
                                                      Title="Type"
                                                      Sortable="true"
                                                      Filterable="true" />

                                <!-- Colonne PDF Count -->
                                <RadzenDataGridColumn TItem="FicheTechnique"
                                                      Title="PDF"
                                                      Sortable="false"
                                                      Filterable="false"
                                                      Width="80px"
                                                      TextAlign="TextAlign.Center">
                                    <Template Context="fiche">
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info"
                                                     Text="@fiche.ImportsPDF.Count.ToString()" />
                                    </Template>
                                </RadzenDataGridColumn>

                                <!-- Colonne Date -->
                                <RadzenDataGridColumn TItem="FicheTechnique"
                                                      Property="DateCreation"
                                                      Title="Date Création"
                                                      FormatString="{0:dd/MM/yyyy}"
                                                      Sortable="true"
                                                      Filterable="true"
                                                      Width="130px" />

                                <!-- Colonne Actions -->
                                <RadzenDataGridColumn TItem="FicheTechnique"
                                                      Title="Actions"
                                                      Sortable="false"
                                                      Filterable="false"
                                                      Width="200px"
                                                      TextAlign="TextAlign.Center">
                                    <Template Context="fiche">
                                        <RadzenButton Icon="description"
                                                      ButtonStyle="ButtonStyle.Info"
                                                      Size="ButtonSize.Small"
                                                      Click="@(() => OuvrirModalPDF(fiche))"
                                                      title="Gérer les PDFs"
                                                      Style="margin: 0 4px;" />

                                        <RadzenButton Icon="edit"
                                                      ButtonStyle="ButtonStyle.Primary"
                                                      Size="ButtonSize.Small"
                                                      Click="@(() => OuvrirModalEdition(fiche))"
                                                      title="Modifier"
                                                      Style="margin: 0 4px;" />

                                        <RadzenButton Icon="delete"
                                                      ButtonStyle="ButtonStyle.Danger"
                                                      Size="ButtonSize.Small"
                                                      Click="@(() => OuvrirModalSuppression(fiche))"
                                                      title="Supprimer"
                                                      Style="margin: 0 4px;" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Composant Modal Création/Édition -->
<FicheTechniqueEditionModal IsVisible="@afficherModalEdition"
                            Fiche="@ficheEnCours"
                            FabricantsDisponibles="@fabricantsDisponibles"
                            TypesProduits="@typesProduits"
                            IsSaving="@sauvegarde"
                            OnSubmit="@SauvegarderFiche"
                            OnClosed="@FermerModalEdition"
                            OnOpenFabricantModal="@OuvrirModalNouveauFabricant"
                            OnOpenTypeProduitModal="@OuvrirModalNouveauTypeProduit" />

<!-- Modal Confirmation Suppression -->
<div class="modal fade @(afficherModalSuppression ? "show d-block" : "")" tabindex="-1" style="@(afficherModalSuppression ? "background: rgba(0,0,0,0.5);" : "")">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" @onclick="FermerModalSuppression"></button>
            </div>
            <div class="modal-body">
                @if (ficheASupprimer != null)
                {
                    <p>Êtes-vous sûr de vouloir supprimer la fiche technique :</p>
                    <p><strong>@ficheASupprimer.NomProduit</strong> de <strong>@ficheASupprimer.NomFabricant</strong> ?</p>
                    @if (ficheASupprimer.ImportsPDF.Any())
                    {
                        <div class="alert alert-warning">
                            <i class="oi oi-warning"></i>
                            Cette action supprimera également <strong>@ficheASupprimer.ImportsPDF.Count fichier(s) PDF</strong> associé(s).
                        </div>
                    }
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="FermerModalSuppression">Annuler</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmerSuppression" disabled="@suppressionEnCours">
                    @if (suppressionEnCours)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Supprimer définitivement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gestion des PDF -->
<GestionPDFModal IsVisible="@afficherModalPDF"
                 FicheTechnique="@fichePDFEnCours"
                 PDFs="@pdfsFiche"
                 PDFsChanged="@OnPDFsChanged"
                 OnPDFAdded="@OnPDFAjoute"
                 OnPDFRemoved="@OnPDFSupprime"
                 OnClosed="@FermerModalPDF"
                 EnableDragDrop="true"
                 DropZoneId="fiches-techniques-main" />

<!-- Composants Modal Réutilisables -->
<FabricantModal IsVisible="@afficherModalNouveauFabricant"
                OnFabricantCreated="@AjouterNouveauFabricant"
                OnClosed="@FermerModalNouveauFabricant" />

<TypeProduitModal IsVisible="@afficherModalNouveauTypeProduit"
                  TypesProduitsExistants="@typesProduits"
                  OnTypeProduitCreated="@AjouterNouveauTypeProduit"
                  OnClosed="@FermerModalNouveauTypeProduit" />

@code {
    private List<FicheTechnique> fiches = new();
    private List<FicheTechnique> fichesFiltrees = new();
    private List<TypeProduit> typesProduits = new();
    private List<TypeDocumentImport> typesDocumentsListe = new();
    private List<string> fabricantsDisponibles = new();
    
    private FicheTechnique ficheEnCours = new();
    private FicheTechnique? ficheASupprimer;
    
    private bool chargement = true;
    private bool sauvegarde = false;
    private bool suppressionEnCours = false;
    
    private bool afficherModalEdition = false;
    private bool afficherModalSuppression = false;
    private bool afficherModalPDF = false;
    private bool afficherModalNouveauFabricant = false;
    private bool afficherModalNouveauTypeProduit = false;
    
    private string filtreRecherche = string.Empty;
    private string rechercheText = string.Empty;
    private FicheTechnique? ficheSelectionnee;

    // Configuration taille fichiers
    private long tailleMaxFichierBytes = 10 * 1024 * 1024; // 10MB par défaut
    private string tailleMaxFichierLabel = "10MB"; // Pour l'affichage dans l'UI

    // Variables pour RadzenDataGrid
    private RadzenDataGrid<FicheTechnique> grid;
    private IEnumerable<FicheTechnique> fichesPourGrid => fichesFiltrees;
    private bool? allGroupsExpanded = false; // false = collapsed par défaut

    protected override async Task OnInitializedAsync()
    {
        await ChargerConfiguration();
        await ChargerDonnees();

        // Vérifier si on doit ouvrir le modal de création automatiquement
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("action", out var action)
            && action == "nouveau")
        {
            // Petit délai pour s'assurer que la page est entièrement rendue
            await Task.Delay(100);
            OuvrirModalCreation();
        }
    }

    private async Task ChargerConfiguration()
    {
        try
        {
            var appSettings = await ConfigurationService.GetAppSettingsAsync();
            tailleMaxFichierBytes = ConfigurationService.ParseTailleMaxFichierToBytes(appSettings.TailleMaxFichierPDF);
            tailleMaxFichierLabel = appSettings.TailleMaxFichierPDF;
        }
        catch
        {
            // Garder les valeurs par défaut en cas d'erreur
            tailleMaxFichierBytes = 10 * 1024 * 1024;
            tailleMaxFichierLabel = "10MB";
        }
    }


    private async Task ChargerDonnees()
    {
        chargement = true;
        try
        {
            fiches = (await FicheTechniqueService.GetAllAsync()).ToList();
            typesProduits = (await TypeProduitService.GetActiveAsync()).ToList();
            typesDocumentsListe = (await TypeDocumentImportService.GetActiveAsync()).ToList();
            fichesFiltrees = fiches.OrderBy(f => f.NomFabricant).ThenBy(f => f.NomProduit).ToList();

            // Extraire les fabricants uniques pour l'autocomplétion (gardé pour les formulaires)
            fabricantsDisponibles = fiches
                .Select(f => f.NomFabricant)
                .Where(f => !string.IsNullOrWhiteSpace(f))
                .Distinct()
                .OrderBy(f => f)
                .ToList();
        }
        finally
        {
            chargement = false;
        }
    }

    private void FiltrerFiches()
    {
        fichesFiltrees = fiches.Where(f =>
            string.IsNullOrEmpty(filtreRecherche) ||
            f.NomProduit.Contains(filtreRecherche, StringComparison.OrdinalIgnoreCase) ||
            f.NomFabricant.Contains(filtreRecherche, StringComparison.OrdinalIgnoreCase) ||
            f.TypeProduit.Contains(filtreRecherche, StringComparison.OrdinalIgnoreCase) ||
            (!string.IsNullOrEmpty(f.Description) && f.Description.Contains(filtreRecherche, StringComparison.OrdinalIgnoreCase))
        ).ToList();
    }

    private async Task ReinitialiserFiltres()
    {
        filtreRecherche = string.Empty;
        rechercheText = string.Empty; // Vide le champ AutoComplete
        ficheSelectionnee = null; // Désélectionner la fiche
        fichesFiltrees = fiches.OrderBy(f => f.NomFabricant).ThenBy(f => f.NomProduit).ToList();

        // Recharger le grid
        if (grid != null)
        {
            await grid.Reload();
        }

        StateHasChanged(); // Force le rafraîchissement du composant AutoComplete
    }

    private void OuvrirModalCreation()
    {
        ficheEnCours = new FicheTechnique();
        afficherModalEdition = true;
    }

    private void OuvrirModalEdition(FicheTechnique fiche)
    {
        ficheEnCours = new FicheTechnique
        {
            Id = fiche.Id,
            NomProduit = fiche.NomProduit,
            NomFabricant = fiche.NomFabricant,
            TypeProduit = fiche.TypeProduit,
            Description = fiche.Description
        };
        afficherModalEdition = true;
    }

    private void FermerModalEdition()
    {
        afficherModalEdition = false;
        ficheEnCours = new FicheTechnique();
    }

    private async Task SauvegarderFiche()
    {
        sauvegarde = true;
        bool estNouvelleCreation = ficheEnCours.Id == 0;
        int? ficheCreeId = null;

        try
        {
            if (estNouvelleCreation)
            {
                var ficheCreee = await FicheTechniqueService.CreateAsync(ficheEnCours);
                ficheCreeId = ficheCreee.Id;
            }
            else
            {
                await FicheTechniqueService.UpdateAsync(ficheEnCours);
            }

            await ChargerDonnees();
            FermerModalEdition();
            FiltrerFiches();

            // Ouvrir automatiquement la modal PDF pour une nouvelle création
            if (estNouvelleCreation && ficheCreeId.HasValue)
            {
                await OuvrirModalPDFApresCreation(ficheCreeId.Value);
            }
        }
        finally
        {
            sauvegarde = false;
        }
    }

    private void OuvrirModalSuppression(FicheTechnique fiche)
    {
        ficheASupprimer = fiche;
        afficherModalSuppression = true;
    }

    private void FermerModalSuppression()
    {
        afficherModalSuppression = false;
        ficheASupprimer = null;
    }

    private async Task ConfirmerSuppression()
    {
        if (ficheASupprimer == null) return;

        suppressionEnCours = true;
        try
        {
            await FicheTechniqueService.DeleteAsync(ficheASupprimer.Id);
            await ChargerDonnees();
            FermerModalSuppression();
            FiltrerFiches();
        }
        finally
        {
            suppressionEnCours = false;
        }
    }

    private FicheTechnique? fichePDFEnCours;
    private List<ImportPDF> pdfsFiche = new();

    private void OuvrirModalPDF(FicheTechnique fiche)
    {
        fichePDFEnCours = fiche;
        // ✅ CORRECTION DOUBLONS FINALE: Éliminer les doublons par ID dès l'ouverture
        pdfsFiche = fiche.ImportsPDF?.GroupBy(p => p.Id).Select(g => g.First()).ToList() ?? new List<ImportPDF>();
        afficherModalPDF = true;
    }

    private async Task OuvrirModalPDFApresCreation(int ficheTechniqueId)
    {
        // Récupérer la fiche complète avec ses relations depuis la liste rechargée
        var ficheComplete = fiches.FirstOrDefault(f => f.Id == ficheTechniqueId);

        if (ficheComplete != null)
        {
            // Délai pour éviter conflit entre fermeture modal édition et ouverture modal PDF
            await Task.Delay(150);
            OuvrirModalPDF(ficheComplete);
        }
    }

    private void FermerModalPDF()
    {
        afficherModalPDF = false;
        fichePDFEnCours = null;
        pdfsFiche.Clear();
    }

    // Callbacks pour la modal de gestion des PDF
    private void OnPDFsChanged(List<ImportPDF> pdfs)
    {
        pdfsFiche = pdfs;
        StateHasChanged();
    }

    private void OnPDFAjoute(ImportPDF pdf)
    {
        // Mettre à jour la source de vérité (liste principale fiches)
        var ficheAMettreAJour = fiches.FirstOrDefault(f => f.Id == fichePDFEnCours?.Id);
        if (ficheAMettreAJour != null)
        {
            ficheAMettreAJour.ImportsPDF.Add(pdf);
            // Recréer la liste locale depuis la source mise à jour AVEC déduplication
            pdfsFiche = ficheAMettreAJour.ImportsPDF.GroupBy(p => p.Id).Select(g => g.First()).ToList();
        }
        FiltrerFiches(); // Rafraîchir l'affichage du grid
    }

    private void OnPDFSupprime(ImportPDF pdf)
    {
        // Mettre à jour la source de vérité (liste principale fiches)
        var ficheAMettreAJour = fiches.FirstOrDefault(f => f.Id == fichePDFEnCours?.Id);
        if (ficheAMettreAJour != null)
        {
            var pdfASupprimer = ficheAMettreAJour.ImportsPDF.FirstOrDefault(p => p.Id == pdf.Id);
            if (pdfASupprimer != null)
            {
                ficheAMettreAJour.ImportsPDF.Remove(pdfASupprimer);
            }
            // Recréer la liste locale depuis la source mise à jour AVEC déduplication
            pdfsFiche = ficheAMettreAJour.ImportsPDF.GroupBy(p => p.Id).Select(g => g.First()).ToList();
        }
        FiltrerFiches(); // Rafraîchir l'affichage du grid
    }

    // Méthodes pour l'autocomplétion (conservées pour les formulaires de création/édition)

    // Nouvelles méthodes pour les modales d'ajout

    private void OuvrirModalNouveauFabricant()
    {
        afficherModalNouveauFabricant = true;
    }

    private void FermerModalNouveauFabricant()
    {
        afficherModalNouveauFabricant = false;
    }

    private void AjouterNouveauFabricant(string nomFabricant)
    {
        if (string.IsNullOrWhiteSpace(nomFabricant))
            return;

        if (!fabricantsDisponibles.Contains(nomFabricant))
        {
            fabricantsDisponibles.Add(nomFabricant);
            fabricantsDisponibles.Sort();
        }

        ficheEnCours.NomFabricant = nomFabricant;
        FermerModalNouveauFabricant();
        StateHasChanged();
    }

    private void OuvrirModalNouveauTypeProduit()
    {
        afficherModalNouveauTypeProduit = true;
    }

    private void FermerModalNouveauTypeProduit()
    {
        afficherModalNouveauTypeProduit = false;
    }

    private void AjouterNouveauTypeProduit(TypeProduit typeProduit)
    {
        if (typeProduit == null)
            return;

        // Vérifier si le type existe déjà dans la liste locale
        var typeExistant = typesProduits.FirstOrDefault(t => t.Id == typeProduit.Id);
        if (typeExistant == null)
        {
            // Ajouter à la liste locale
            typesProduits.Add(typeProduit);
            typesProduits.Sort((a, b) => a.Nom.CompareTo(b.Nom));
        }

        // Assigner à la fiche en cours
        ficheEnCours.TypeProduit = typeProduit.Nom;

        FermerModalNouveauTypeProduit();
        StateHasChanged();
    }

    private string? GetValidationMessage(System.Linq.Expressions.Expression<Func<string>> accessor)
    {
        // Cette méthode pourrait être améliorée pour retourner les messages de validation
        // Pour l'instant, on retourne null pour simplifier
        return null;
    }

    // Méthode helper pour l'affichage
    private string GetFicheDisplayText(FicheTechnique fiche)
    {
        return $"{fiche.NomProduit} - {fiche.NomFabricant}";
    }

    // Méthodes pour la recherche de fiches techniques
    private void OnFicheTechniqueSearchSelected(FicheTechnique fiche)
    {
        ficheSelectionnee = fiche;
        // Conserver le filtrage actuel au lieu de montrer seulement la fiche sélectionnée
        // Le filtrage est maintenu par le texte de recherche existant
    }

    private async Task OnFicheTechniqueSearchChanged(string searchText)
    {
        filtreRecherche = searchText;
        rechercheText = searchText; // Synchroniser la variable de contrôle

        if (string.IsNullOrWhiteSpace(searchText) || searchText.Length < 2)
        {
            // Si le texte est vide ou trop court, afficher toutes les fiches (ou appliquer les autres filtres)
            FiltrerFiches();
            ficheSelectionnee = null;
        }
        else
        {
            // Filtrer en temps réel basé sur la recherche textuelle unifiée
            fichesFiltrees = fiches.Where(f =>
                f.NomProduit.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                f.NomFabricant.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                f.TypeProduit.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrEmpty(f.Description) && f.Description.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            ).OrderBy(f => f.NomFabricant).ThenBy(f => f.NomProduit).ToList();
        }

        // Recharger le grid après filtrage
        if (grid != null)
        {
            await grid.Reload();
        }

        // Force le rafraîchissement de l'affichage
        StateHasChanged();
    }

    // ===== MÉTHODES RAZDENDATAGRID GROUPING =====

    void OnRender(DataGridRenderEventArgs<FicheTechnique> args)
    {
        if (args.FirstRender)
        {
            // Définir le grouping par défaut au premier rendu
            args.Grid.Groups.Add(new GroupDescriptor() { Property = "NomFabricant", SortOrder = SortOrder.Ascending });
            StateHasChanged();
        }
    }

    void OnGroupRowRender(GroupRowRenderEventArgs args)
    {
        // Gérer l'état collapsed/expanded des groupes
        if (args.FirstRender && allGroupsExpanded != null)
        {
            args.Expanded = allGroupsExpanded.Value;
        }
    }

    void OnGroupRowExpand(Group group)
    {
        // Event appelé quand un groupe est expanded
        // Pour le moment, pas d'action spécifique
    }

    void OnGroupRowCollapse(Group group)
    {
        // Event appelé quand un groupe est collapsed
        // Pour le moment, pas d'action spécifique
    }

    void ToggleTousLesGroupes()
    {
        // Toggle entre expanded/collapsed
        allGroupsExpanded = !(allGroupsExpanded ?? false);
    }
}

<style>
    /* ===== DRAG & DROP STYLES ===== */
    .upload-zone {
        border-color: #dee2e6 !important;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .upload-zone:hover {
        border-color: #adb5bd !important;
    }

    .upload-zone.drag-hover {
        border-color: #0d6efd !important;
        background-color: #e7f1ff;
        transform: scale(1.02);
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.3);
    }

    /* ===== RAZDENDATAGRID CUSTOM STYLES ===== */
    .rz-datatable-fiches {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .rz-datatable-fiches .rz-grid-table {
        font-size: 0.95rem;
    }

    .rz-datatable-fiches .rz-data-grid-group-row {
        background-color: var(--info);
        color: white;
        font-weight: 600;
        padding: 12px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .rz-datatable-fiches .rz-data-grid-group-row:hover {
        background-color: #0a9ec9; /* var(--info) légèrement plus clair au survol */
    }

    /* Actions buttons spacing */
    .rz-datatable-fiches .rz-button {
        margin: 0 4px;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .rz-datatable-fiches {
            font-size: 0.85rem;
        }

        .rz-datatable-fiches .rz-button {
            margin: 2px;
        }
    }
</style>